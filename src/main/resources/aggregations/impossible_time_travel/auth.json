{
  "query": {
    "match_all": {}
  },
  "size": 0,
  "aggs": {
    "itt": {
      "composite": {
        "size": 2,
        "sources": [
          {
            "hostname": { "terms": {"field": "host.hostname.keyword"}}
          },
          {
            "user_id": {"terms" : {"field": "user.name.keyword"}}
          }
        ]
      },
      "aggregations": {
        "ip_list": {
          "scripted_metric": {
            "init_script": "state['ips'] = new ArrayList()",
            "map_script": "state['ip'] = doc['source.ip.keyword']; state.ips.add(state['ip'].value)",
            "combine_script": "List combined = new ArrayList(); for (ip in state.ips) combined.add(ip); return combined",
            "reduce_script": "List final = new ArrayList(); for (ip_list in states) final.addAll(ip_list); return final.stream().distinct().sorted().collect(Collectors.toList());"
          }
        }
      }
    }
  }
}